---
title: "The Comparative Method"
author: "Heath Blackmon"
date: "Last updated: `r Sys.Date()`"
output: html_document
---

This page illustrates some of the ideas presented in Felsenstein's landmark 1985 paper.  First lets illustrate the problem that Felsenstein shows in his figures 5 and 6.

First we will build the tree where we have two groups of 20 species each sharing a star pattern of descent

```{r}
library(ape)
library(phytools)
library(evobiR)
library(geiger)
tree <- read.tree(text = "((A:2,B:2,C:2,D:2,E:2,F:2,G:2,H:2,I:2,J:2,K:2,L:2,M:2,N:2,O:2,P:2,Q:2,R:2,S:2,T:2):6,(a:2,b:2,c:2,d:2,e:2,f:2,g:2,h:2,i:2,j:2,k:2,l:2,m:2,n:2,o:2,p:2,q:2,r:2,s:2,t:2):6);")
plot(tree, type="cla", show.tip.label = F)
```

Now lets evolve a pair of traits along this phylogeny assuming a brownian motion model of evolution:

```{r}
set.seed(1)
x <- fastBM(tree)
y <- fastBM(tree)
```

If we were to ignore phylogeny we would now want to do a correlation test and determine if our traits were correlated:

```{r}
cor.test(x,y)
```

So a highly significant correlation.  We might plot it and see just what the data looks like:
```{r}
plot(x,y)
abline(lm(y~x))
```

However if we recolor the plot then we see that we really have two clouds of values that correspond to our two groups of species.

```{r}
par(mfcol=c(1,2))
plot(tree, type="cla", show.tip.label = F)
tiplabels(col=c(rep("blue", 20),rep("red", 20)), pch=16) 
plot(x,y, col=c(rep("red", 20), rep("blue", 20)), pch=16)
```

Lets look at the correlation within our species groups:

```{r}
# first the red species
cor.test(x[1:20],y[1:20])

# now the blue species
cor.test(x[21:40],y[21:40])
```

So here we see that the correlation within groups is not significantly different from zero.  Now lets calculate the PICs for both of these and plot the cotrasts against each other.

```{r}
set.seed(1)
x.pic <- pic(x, multi2di(tree))
y.pic <- pic(y, multi2di(tree))
plot(x.pic,y.pic, col=c(rep("blue", 20), rep("red", 20)), pch=16)
```

Now we can test for whether these are correlated.  One note unlike the original data when analyzing PICs you always need to force the regression through the origin. Below you can see how we do this in R:


```{r}
fit <- lm(x.pic ~ 0 + y.pic)
summary(fit)
```

Since these data were simulated independently this is the result we would expect.

# Can phylogenetic correction increase significance?

In my own personal experience I haven't run across this often with empirical data.  Despite this it is easy enough to imagine a situation where it would.  Specifically when two traits are tightly correlated and both respond quickly to selection we can see phylogenetic correction increase significance.

```{r}
# first make a basic tree
tree <- read.tree(text = "((((a:.1,b:.1):1.0,(c:.1,d:.1):1.0):1.0,((e:.1,f:.1):1.0,(g:.1,h:.1):1.0):1):1.0,(((i:.1,j:.1):1.0,(k:.1,l:.1):1.0):1.0,((m:.1,n:.1):1.0,(o:.1,p:.1):1.0):1.0):1.0):1.0;")

# now make a version with lengthened tips
tree2 <- read.tree(text =
"((((a:3,b:3):1.0,(c:3,d:3):1.0):1.0,((e:3,f:3):1.0,(g:3,h:3):1.0):1):1.0,(((i:3,j:3):1.0,(k:3,l:3):1.0):1.0,((m:3,n:3):1.0,(o:3,p:3):1.0):1.0):1.0):1.0;")

par(mfcol=c(1,2))
plot(tree2, type="cla", show.tip.label = T, main="Simulation")
plot(tree, type="cla", show.tip.label = T, main="True Tree")
```

We will use tree 1 to simulate the data.  By lengthining the terminal tips and simulating two traits that are highly corelated we essentially produce data as described above.

```{r}
s<- matrix(c(1.1,.5,.5,1.1),2,2)
colnames(s) <- rownames(s) <- c("X","Y")
set.seed(15)
csims <- sim.char(tree2, s, 1)[,,1]
x <- csims[,1]
y <- csims[,2]
```

Now we can perform a correlation test naive of the phylogeny:

```{r}
cor.test(x,y)
```

So here we see that we don't quite reach significance in our uncorrected test.  Next lets account for phylogeny using tree 2.  Now we are taking into account that tips like _a_ and _b_ have had very little time to diverge but they will have done so more than expected and in a correlated fashion based on the phylogeny.

```{r}
x.pic <- pic(x, multi2di(tree))
y.pic <- pic(y, multi2di(tree))
fit <- lm(x.pic ~ 0 + y.pic)
summary(fit)
```

And we can see that indeed with the PICs we now get a significant result.

**caveats**
Pretty sure that this would fail the requirement that there should not be a correlation between contrasts and their standard deviation.  Also my thought was this would work every time.  However, I tried 10 values for the seed on the simulation for this second dataset and only 2 produced the pattern I expected.... so more work required.




