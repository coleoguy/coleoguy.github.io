---
title: "SAGA tutorial"
author: "Heath Blackmon and Jeffery Demuth"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
      fig_caption: yes
      toc: true
vignette: >
  %\VignetteIndexEntry{SAGA tutorial}
  %\VignetteEngine{knitr::knitr}
  %\usepackage[utf8]{inputenc}
---

_______
## Introduction

Line cross analysis (LCA) or partitioning the contribution of composite genetic effects (CGEs) to the mean phenotype of cohorts is widely used to investigate the genetic architecture of traits.  This approach uses two parental strains which have diverged in a phenotype of interest.   These parents are crossed, producing an F1, and subsequent crosses (e.g. F2, backcross, reciprocals) are made to generate groups that have different combinations of parental genes.  We refer to each of these groups as cohorts.  Using a weighted least squares regression with weights inversely proportional to the variance of the cohort means, the degree to which a phenotype is determined by different CGEs (e.g. additive, dominance, and epistatic gene action) may be estimated [1, 2]. Traditionally LCA has been accomplished by a process refereed to as the joint-scaling test, essentially forward variable selection weighted least squares regression.  However this approach has a number of documented problems [^3]. A full information-theoretic (I-T) approach to model selection and parameter estimation alleviates difficulties associated with previous approaches and provides additional understanding that is not possible under older approaches such as the joint-scaling test [4].  SAGA provides a full I-T approach to LCA that leverages the finite sample size corrected version of the Akaike information criterion (AICc) to explore all possible models and make unbiased and, when appropriate, model averaged estimates of the contribution of CGEs to cohort means.  SAGA includes four functions and seven empirical datasets.

Functions:

- __AnalyzeCrossesMM__: Primary function that generates and tests all models of genetic architecture possible for a given set of cohorts.
- __EvaluateModel__: Returns parameter estimates conditional on a single model.
- __VisModelSpace__: Plots the distribution of Akaike weights across model space.
- __DisplayCmatrix__: Loads the default C-matrix as a dataframe

Data:

- __ban.osa__: Number of offspring from crosses involving _Tribolium castaneum_ from Ecuador and Japan [5]
- __dar.bho__: Number of offspring from crosses involving _Tribolium castaneum_ from Tanzania and India [5]
- __per.inf__: Number of offspring from crosses involving _Tribolium castaneum_ from Peru and Portugal [5]
- __sin.cro__: Number of offspring from crosses involving _Tribolium castaneum_ from Malaysia and Croatia [5]
- __PH__: Height data for crosses involving strains of _Nicotiana rustica_ [2].
- __SL__: Sperm length data for crosses between disjunct populations of _Drosophila mojavensis_ [6].
- __SR__: Sperm receptacle length data for crosses between disjunct populations of _Drosophila mojavensis_ [6].

_______

## Mathematical Approach

We use the function GLM from the base R package to perform weighted least square regression [7].  GLM returns the parameter and standard error estimates conditional on the model as well as the AIC value for the model. We convert AIC to AICc using equation 1.  Where n is the number of cohorts and K is the number of parameters being estimated.

![Equation 1](1.png)

We then calculate AICc differences (delta AICc) using equation 2.

![Equation 2](2.png)

Where delta AICc min is the minimum AICc score calculated across all possible models and AICci is the AICc calculated for a specific model.  Delta AICc is used in generating Akaike weights (_wi_) using equation 3.  The denominator in this equation is the summation of the numerator across all possible models being evaluated (R).

![Equation 3](3.png)

Under the default settings, if _wi_ of the best model is 0.9 or greater then SAGA will perform parameter estimation under a single model. If no model reaches this threshold then we construct a 95% confidence set of models that contains the minimum number of models whose _wi_ sum to 0.95. To calculate model averaged parameter estimates and unconditional standard errors we recalculate _wi_ for each model performing the summation in the denominator of equation 3 across all models in the confidence set. The model weighted parameter estimates  are then calculated using equation 4 where _wi_ is the recalculated model weight and _omega hat i_ is the parameter estimate from the model; the product of these values is summed across all models R in the confidence set.

![Equation 4](4.png)

Standard error estimates that are unconditional on any one model are calculated using equation 5. 

![Equation 5](5.png)

Finally variable importance _vi_ is calculated by summing _wi_ of all models R in which a CGE occurs (Eq. 6).  

![Equation 6](6.png)

_______

## Installation

A stable tested version of SAGA is available from the CRAN repository or the most recent version may be installed from github using the devtools package: 

Installing from CRAN

    install.packages("SAGA")

Installing from github

    library(devtools)
    install_github("coleoguy/SAGA", build_vignettes = TRUE)

_______

## Fitting LCA models

__C-matrix of composite genetic effects__  
The first step in analysis of line cross data is choice of a C-matrix that describes the expected contribution of different types of gene action to cohort phenotypes.  By default SAGA will use a C-matrix that is scaled to the midparent mean (equivalent to F<sub>inf</sub>), and includes 23 potential CGEs. For each CGE we have calculated coefficients for 24 potential crosses; each of which is divided into male, female, or mixed sex cohorts. This C-matrix has 72 rows and the row numbers are used to identify the cohorts being used in an experiment. The function DisplayCmatrix is available so that we can determine what IDs should be used to identify the cohorts included in an analysis.

    # print the C-matrix to the terminal
    DisplayCmatrix(table = "MP")


__Table 1.__ The first 15 rows of the C-matrix supplied with SAGA.
```{r, echo=FALSE, results='asis'}
foo <- read.csv(system.file("Cmatrix.mp.csv", package ="SAGA"))[1:15,1:16]
knitr::kable(foo, row.names=T, output=T)
```

__Input Data Format__

Data that will be analyzed with SAGA should be in a dataframe with three columns: 

- id of the cohort which should match the appropriate row of the C-matrix above  

- mean phenotype measure of the cohort  

- standard error of the cohort's mean phenotype.  

SAGA comes with several empirical datasets allready appropriately formatted.  Here we will load data on the number offspring produced by crosses involving _Tribolium castaneum_ from Tanzania and India [6].

    data(per.inf, package="SAGA")

__Table 2.__ per.inf data illustrating the format required for analysis with SAGA.
```{r, echo=FALSE, results='asis'}
data(per.inf, package="SAGA")
colnames(per.inf) <- c("Cohort ID", "Mean", "SE") 
knitr::kable(per.inf, row.names=T, output=T)
```

To look up your cohorts and determine what id numbers to use you can use the function `cohortID` this function will return a data frame with the ID nubmer for each type of cohort.  Parents are listed in parentheses and are in the order sire x dam.

```{r}
SAGA::cohortID()
```

__Analyze Models__

Once data is prepared as above we can analyze it with the function `AnalyzeCrossesMM`. This function has a variety of arguments to allow control of the analysis:

Arguments

- **data:**	 a data frame with the first three columns: 1) id of the cohort this must mach the coeficient row of the c-matrix 2) mean phenotype measure of the cohort 3) Standard error of the cohort's mean phenotype
- __Cmatrix:__	 Selection of mid-parent scaled c-matrix ("MP") if an alternative c-matrix table is desired it may be provided here as a dataframe
- __model.sum:__	 This is the sum of the probability of the models to be included
- __max.models:__	 The maximum number of fitted models to return from the function. This is included as an option to allow analysis of large model space on computers with limited RAM.
- __even.sex:__	 A logical by default it is false. It should be set as true if either sexed cohorts are included or if mixed sex cohorts are included but have equal numbers of males and females.
- __graph:__	 Logical indicating whether a plot of results should be produced
- __cex.axis:__	 expansion factor for numeric axis labels.
- __cex.names:__	 expansion factor for name labels.
- __cex.main:__	 expansion factor for main title.


This will return a list of the class "genarch".  The list has four elements:

- __models:__ a list containing the weighted least squares solution for all models tested.
- __estimates:__ a data frame containing Model Weighted Average for each parameter and its unconditional standard error.
- __daicc:__ a vector of the delta AICc scores for all models tested.
- __varimp:__ a data frame containing the _vi_ scores for composite effects

As SAGA is analyzing the data it will print the composite effects being tested
as well as progress in analyzing models to the terminal, and by default a plot of the primary results of the analysis.  In this case none of the models tested has a _wi_ greater than 95%. So the plot is of the model averaged parameter estimation from equation 4, and unconditional standard errors calculated in equation 5 are indicated with whiskers on each bar.  The colors of the bars reflects the _vi_ calculated in equation 6.:

```{r,fig.cap='__Figure 1.__ Model averaged estimate of genetic architecture.', echo=TRUE, warning=FALSE,results='markup', fig.width=6.5}
# we will need the plotrix package for plotting
library(plotrix)
results <- SAGA::AnalyzeCrossesMM(per.inf, graph=T, cex.names=.8)
```

Now we can load a different dataset to demonstrate what happens when there is less model selection uncertainty.  This dataset is from a study of sperm receptacle length measured in crosses between disjunct populations of _Drosophila mojavensis_ [6].

    #Sperm receptacle length in Drosophila mojavensis
    data(SR)
    #Because we are using cohorts where we know the distribution of sexes we set sexed=T.
    AnalyzeCrossesMM(SR, sexed=T, graph=T)

```{r, fig.cap='__Figure 3.__ Conditional estimate of genetic architecture.', echo=TRUE, warning=FALSE, results='markup', fig.width=6}
library(plotrix)
data(SR, package="SAGA")
results2 <- SAGA::AnalyzeCrossesMM(SR, even.sex=T, graph=T)
```

In this case a single model has a _wi_ of greater than 97%, and as figure 2 illustrates SAGA has returned estimates based on this single model.

_______
## Plotting Results

To plot something differently than the default plot returned from the analysis access the results stored in the second element of the genarch object.

```{r,fig.cap='__Figure 2.__ Subset of model averaged estimate of genetic architecture.', echo=TRUE, warning=FALSE, results='hide', fig.width=6.5}
    # here we extract the 4 largest composite effects found in the first analysis
    estimates <- as.numeric(results[[2]][1, c(3, 7, 8, 9)])
    names(estimates) <- colnames(results[[2]])[c(3, 7, 8, 9)]
    barplot(estimates, main = "Estimate for composite effects",
            names.arg = names(estimates))
```

To alleviate the need to manually build a plot from scratch like above we have provided an S3 plot method for `genarch` objects. It has many useful built-in options such as restricting the plot to only include those CGEs that have a *vi* score over a cutoff that you set.  It also allows you to adjust the axis labels and color pallet to be used.  For instance, here are 3 versions of the same results.


```{r,fig.cap='**Figure 3a.** The standard full plot returned from the analysis', fig.width = 5.5, fig.height = 3, echo=F}
# first the standard full plot returned from the analysis
SAGA::plot.genarch(results, min.vi=0)
```


```{r,fig.cap='**Figure 3b.** Now we can reduce the plot to include just those CGEs with a *vi* of at least .25', fig.width = 5.5, fig.height = 3, echo=F}
SAGA::plot.genarch(results, min.vi=.25)
```

```{r, fig.cap='**Figure 3c.** Now lets use the viridis color pallete and make it color blind friendly, adjust the Y axis, and change the main title.', fig.width = 5.5, fig.height = 3, echo=F}
SAGA::plot.genarch(results, maxval=85, min.vi=.253, main="A nicer plot", viridis=T)
```

_______
## Assesing model uncertainty

The relative fit of models to the data can be explored using the function 'VisModelSpace'.  This function will plot a box for each model tested and will color it based on its _wi_.  The models are organized from the simplest model (autosomal additive) in the bottom left hand corner and increase in complexity from left to right (first all one parameter models then all two parameter models etc.) once the right hand side of the plot is reached a second row is added above the first.  Only models evaluated and stored in the genarch object are plotted - for instance a model removed due to a colinearity will not be represnted in the plot.  To illustrate the differences in model space we can plot the results of the two analyses stored in `results` and `results2`.  First lets look at the _Tribolium_ analysis which indicated a nontrivial level of model selection uncertainty.  The results from this analysis are stored in `results`

    VisModelSpace(results, cex.u=1.6)

```{r, fig.cap='__Figure 4.__ Distribution of akaike weights across model space for Tribolium dataset.', echo=FALSE, warning=FALSE, results='hide', fig.width=5.5, fig.height=5}
SAGA::VisModelSpace(results, cex.u=1.6)
```

This plot shows us that their are a number of models of varying complexity that have very similar akaike weights, and this dataset highlights why our understanding of the genetic architecture should not be based on any single model.

Next lets create the same plot but this time for the _Drosophila_ dataset which indicated very little model selection uncertainty.  The results from our analysis of this dataset are stored in `results2`.

    VisModelSpace(results2, cex.u=.4)

```{r, fig.cap='__Figure 5.__ Distribution of akaike weights across model space for Drosophila dataset.', echo=FALSE, warning=FALSE, results='hide', fig.width=5.5, fig.height=5}
SAGA::VisModelSpace(results2, cex.u=.4)
```

SAGA also provides the ability to investigate the results of individual models.  For instance in the case of the first dataset we could use the daicc scores stored in the third element of the genarch object to find the best two models and then plot these using the function `EvaluateModel`.  To illustrate this lets find the best two models from the _Tribolium_ dataset and plot them side by side to see how they differ.

    # first lets find the best two models
    good.models <- order(results[[3]])[1:2]
    EvaluateModel(results, good.models[1], cex.names=.7, cex.main=.7)
    EvaluateModel(results, good.models[2], cex.names=.7, cex.main=.7)
    
```{r, echo=FALSE, warning=FALSE, results='hide'}
SAGA::EvaluateModel(results, 166, cex.names=.7, cex.main=.7)
SAGA::EvaluateModel(results, 110, cex.names=.7, cex.main=.7)
```

__Figure 6.__ Estimates conditional on individual models. 

Here we can see that the top two models both include 3 composite genetic effects, and in both cases the strongest effect is assigned to autosomal additive by autosomal dominance epistasis.  We can also see that the first model includes autosomal dominance by dominance epistasis while in the second this is replaced by simple autosomal dominance.

_______
## Conclusion

Users should consider the presence of linear dependencies in C-matrices.  Depending on your choice of cohorts some CGEs will likely be linearly dependent.  This means that they can not be distinguished from each other and can not be estimated simulataniouusly.  SAGA deals with this first by dropping any higher order CGEs that are perfectly correlated with a lower order effect from the C-matrix being used.  However some combinations of CGEs may still be highly correlated (colinear) with each other.  SAGA deals with this by dropping any model that includes the CGEs that are highly correlated.  The importance and magnitude of each particular CGE involved in the colinearity is estimated only by the subset of models where it still appears.  In our experience a strong signal of the importance of CGEs remains, but not surprisingly the parameter estimates become less accurate and the variable importance scores will be lower.  When variables with high v_i scores do not appear jointly in the equations included in the confidence set, it is a strong indication that there is a colinearity, and warrants additional investigation.  Often the only solution to this problem will be a careful examination of the C-matrix to determine what type of additional cohort(s) could be measured to most effectively demonstrating the difference in the contribution of CGEs that are confounded.

Despite the improvements provided by implementing an I-T approach in SAGA, we would caution users that in our analysis of simulated datasets we have found that spurious variables are often included in models that are part of the confidence set.  These spurious variables are likely included because they are able to explain some stochastic noise in the dataset.  However, these are usually easily identified by small parameter estimates with standard errors overlapping zero.  	

In reporting the results of line cross analysis experiments we recommend reporting estimates and standard errors from model averaged results unless a single model has greater than 95% _wi_.  It is also important to report _vi_ scores since these give an indication of our certainty that a particular composite genetic effect is important in the genetic architecture of the trait in question.  Finally, although one of the benefits of our approach is a move away from strict arbitarily defined p-values we have found that as a rule of thumb across all simulated datasets that we have analyzed _vi_ scores of greater than 50% have only been associated with CGEs that were included in the generating model.

_______

## Citations
[1] Mather, K., and J. L. Jinks, 1982 Biometrical genetics: The study of continuous variation. Chapman and Hall, London.

[2] Lynch, M., and B. Walsh, 1998 Lynch, M., & Walsh, B. (1998). Genetics and analysis of quantitative traits. Sinauer Associates, Inc., Sunderland, Massachusetts.

[3] Whittingham, M. J., P. A. Stephens, R. B. Bradbury and R. P. Freckleton, 2006 Why do we still use stepwise modelling in ecology and behaviour? J Anim Ecol 75: 1182-1189.

[4] Burnham, K. P., and D. R. Anderson, 2002 Model selection and multimodel inference: a practical information-theoretic approach. Springer, New York.

[5] Demuth, J. P., 2004 Evolution of Hybrid Incompatibility in the beetle Tribolium Castaneum, pp. 152 in Biology. Indiana University, Bloomington.

[6] Miller, G. T., Starmer, W. T., & S. Pitnick 2003. Quantitative genetic analysis of among-population variation in sperm and female sperm-storage organ length in Drosophila mojavensis. Genetical research, 81(03), 213-220.

[7] R Development Core Team, 2013 R: A Language and Environment for Statistical Computing, pp., Vienna, Austria.
