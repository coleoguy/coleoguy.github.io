---
title: "Confidence Intervals"
author: "Heath Blackmon"
date: '2022-08-31'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Our population

The first step that we will take is to create a population that we are going to sample from. In this case lets imagine a lake where we are interested in the size of the diving beetle *Tropisternus lateralus*. A common distribution that approximates what we see in nature in this type of situation is a normal distribution.

```{r}
pop <- rnorm(100000, mean = 1.45, sd = 0.25)
# here we are drawing 100000 values from a normal
# distribution with a mean of 1.45 and a standard deviation
# of 0.25
```

## The true population

Lets take a look at the true population using the function histogram that will show us what it looks like.


```{r, echo=FALSE}
hist(pop, xlab="length (cm)", main="T. lateralis in lake A")
```

## Sampling from the lake 

Here we will take a sample from the lake using the function `sample`

```{r}
# first we take a small sample of 10 individuals from
# our population
smsamp <- sample(pop, 10)
# next we take a large sample of 100 individuals
lgsamp <- sample(pop, 100)
```

## Confidence Interval

Lets look at the confidence interval that we can calculate from the samples that we have taken. Rather than coding in the math to calculate the confidence interval by hand we can use the function `t.test` to get the confidence interval.

```{r}
smsamp.conf <- t.test(smsamp)$conf.int
lgsamp.conf <- t.test(lgsamp)$conf.int
```

lets look at those results:

```{r}
smsamp.conf
lgsamp.conf
```

## What does the confidence interval really tell us

Since we are doing all of this in simulation we can repeat our experiment many times and evaluate what is happening in comparison to the truth which is also known since we created the variable `pop` at the beginning of this document.

```{r}
# first lets store the true mean of the population (mu) 
# remember from last lecture this is a parameter
mu <- mean(pop)

# now lets create some variables to keep track of stuff
# first I will create a matrix that I can hold the confidence
# intervals in when I calculate them.
conf.ints <- matrix(data = NA, nrow = 1000, ncol = 4)

# these next two variables will hold T or F to let me know
# whether the population parameter mu falls within the 
# confidence interval.
smsamp <- lgsamp <- c()

# This will perform the experiments 1000 times
for(i in 1:1000){
  
  # These next two lines are me sampling the population
  sm <- sample(pop, size=10)
  lg <- sample(pop, size=100)
  
  # Now I am recording the 95% confidence interval from 
  # each sample that I took.
  conf.ints[i,1:2] <- t.test(sm)$conf.int
  conf.ints[i,3:4] <- t.test(lg)$conf.int
  
  # now I am just recording whether or not I captured the
  # true mean.
  smsamp[i] <- mu >= conf.ints[i,1] & mu <= conf.ints[i,2]
  lgsamp[i] <- mu >= conf.ints[i,3] & mu <= conf.ints[i,4]
}
```

So now we could look at `smsamp` and `lgsamp` to see how often we captured the true mean:

```{r}
# first with our small samples
sum(smsamp)/length(smsamp)

# and now with our large samples
sum(lgsamp)/length(lgsamp)
```

So it worked in both cases the true mean was captured by the confidence interval 95% of the time. Lets look at a possible visualization for this data:

```{r}
# this line is going to use the par function to set some
# of the plotting parameters. Specifically here I tell R 
# that I want to split my plotting window into one row
# and two columns.
par(mfcol=c(1,2))

# i'm going to get the minimum and maximum values in
# my data so I can have things layed out nicely and the
# same scale in both plots
minx <- min(conf.ints)
maxx <- max(conf.ints)

# first I will plot the small sample size I'm going to
# start off with a blank plot with only mu plotted as a
# black vertical line.
plot(x = c(mu, mu),y = c(0, 1000), type = "l",
     xlim = c(minx, maxx), xlab = "length",
     ylab = "simulation number", main = "N=10")

# now I will add light red lines to show the confidence
# intervals calculated by each small sample i took
for(i in 1:1000){
  lines(x = c(conf.ints[i, 1], conf.ints[i, 2]),
        y = c(i, i), col = "red", lwd=.1)
}

# now I'm simply repeating but for the large sample sizes
plot(x = c(mu, mu),y = c(0, 1000), type = "l",
     xlim = c(minx, maxx), xlab = "length",
     ylab = "simulation number", main = "N=100")
for(i in 1:1000){
  lines(x = c(conf.ints[i, 3], conf.ints[i, 4]),
        y = c(i, i), col = "red", lwd=.1)
}

```

So this really also does a good job of illustrating just how much power we get from increasing our sample size. **Sample size directly dictates how small of a difference you will be able to detect between two groups in an experiment.**

## So what went wrong in class on Tuesday?

I was wrong! I forgot that the 95% confidence interval is not guranteed to contain the true mean 95% of the time unless the underlying parameter has a normal distribution. Can you think of why it may have failed when it was exponentially distributed?
